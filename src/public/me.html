<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Me</title>
  <style>
      .username {
          font-weight: bold;
      }

      .contacts {
          margin-top: 2rem;
          display: flex;
          flex-flow: row nowrap;
          justify-content: flex-start;
          align-items: center;
          gap: 2rem;
      }
  </style>
  <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="module">
  const { startAuthentication } = SimpleWebAuthnBrowser

  const rootElement = document.getElementById('root')

  const user = await fetch('/me').then(res => res.json())

  const userName = document.createElement('p')
  userName.classList.add('username')
  userName.innerText = `User: ${ user.username }`
  rootElement.appendChild(userName)

  const userDisplayName = document.createElement('p')
  userDisplayName.classList.add('username')
  userDisplayName.innerText = `Known as: ${ user.displayName }`
  rootElement.appendChild(userDisplayName)

  const contacts = document.createElement('div')
  contacts.classList.add('contacts')
  rootElement.appendChild(contacts)

  const emailLabel = document.createElement('p')
  emailLabel.innerText = `Email: ******************`
  contacts.appendChild(emailLabel)

  const revealButton = document.createElement('button')
  revealButton.type = 'button'
  revealButton.innerText = 'Reveal'
  contacts.appendChild(revealButton)
  revealButton.addEventListener('click', async () => {
    const { email } = await fetch('/me/email').then(async res => {
      const result = await res.json()
      if (res.ok) {
        return result
      }

      if (res.status === 428) {
        const { challenge } = JSON.parse(result.message)
        const assertionResponse = await startAuthentication({ optionsJSON: challenge })
        return fetch('/me/email', {
          headers: {
            'x-2fa-challenge-response': btoa(JSON.stringify(assertionResponse)),
          },
        }).then(res => res.json())
      }
    })
    emailLabel.innerText = `Email: ${ email }`
    revealButton.style.display = 'none'
  })

</script>
</body>
</html>